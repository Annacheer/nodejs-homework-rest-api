Добавление аватара

1.npm install --save multer
Инсталл. multer

2.npm run start:dev
Запустим проект

3.Из multer сделать middleware, чтобы файлы ложить во временную папку, а в request body записывать текст.

4.Сначала создаем необходимые папки, в которых multer будет временно хранить файлы: temp (она будет пустой, но пустые папки на Git не пушатся), поэтому создаем в ней пустой файл .gitkeep

5.Файлы, которые будем отдавать на фронтенд, будем сохранять в папке public/avatars - там будем зранить аватары пользователей, создаем в ней пустой файл .gitkeep

6.Создаем новый файл multer-config.js. Импортируем multer и создаем объект настроек, а потом с его помощью middleware, который будет загружать файлы

7.Создаем объект настроек - multerConfig, вызываем метод discStorage и передаем ему объект, в котором описываем настройки - нужна только 1 обязательная настройка - destination (путь ко временной папке), адрес запроса пишем через path, поэтому импортируем path

8.Создаем путь ко временной папке - tempDir (все файлы с начала будут сохраняться тут)

9.Вторая настройка - это filename - туда мы передаем функцию и она может сохранить нам файл не под тем именем, под которым он пришел, это иногда необходимо

10.Создаем middleware (upload)- вызываем multer как функцию, передаем объект настроек - в свойстве storage указываем multerConfig - настройки multer. Middleware готов, она будет сохранять файлы в папке tempDir под оригинальным именем (originalname)

11.Для middleware upload нужно указать в каких полях мы ожидаем файл. мы ожидаем 1 файл в поле avatar - upload.single("avatar") - это указано также в Postman - /users/register - POST - form-data - avatar + загруженное фото

12.Нажав send в Postman, middleware сохранил фото в папке temp, в req.file - информацию про файл, а в req.body - все текстовые элементы.

13.// upload.array("avatar", 8) - если нужно загрузить больше, чем 1 файл - название поля, количество

14.// upload.fields([{name: "cover", maxCount: 1}, {name: "subcover", maxCount: 2}]) - если ожидаем файлы в разных полях

15.Теперь нужно переместить файлы из temp в public/avatars. За все перемещения файлов отвечает пакет fs. Импортируем его

16.Чтобы переместить файл, в fs используется метод rename -
await fs.rename(tempUpload, resultUpload); -
1й аргумент - старый путь к файлу + его имя; 2й аргумент - новый путь к файлу + его имя;
