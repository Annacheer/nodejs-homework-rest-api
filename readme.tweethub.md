Добавление аватара

В Postman выбираем метод POST, form-data, key-avatar, вместо Text быбираем File, прикрепляем аватар.

1.npm install --save multer
Инсталл. multer

2.npm run start:dev
Запустим проект

1. В app.js прописываем app.use(express.static("public")); - Если придет запрос на статичный файл, его нужно искать в папке public

4.Сначала создаем необходимые папки, в которых multer будет временно хранить файлы: temp (она будет пустой, но пустые папки на Git не пушатся), поэтому создаем в ней пустой файл .gitkeep

5.Создаем public/avatars. Файлы, которые будем отдавать на фронтенд, будем сохранять в папке public/avatars - там будем хранить аватары пользователей, создаем в ней пустой файл .gitkeep

6.Создаем новый файл multer-config.js в папке middlewares. Импортируем multer и создаем объект настроек multerConfig, а потом с его помощью middleware - upload, который будет загружать файлы

3.Из multer сделать middleware, чтобы файлы ложить во временную папку, а в request body записывать текст. Текстовые поля идут в request body, а файлы - в папку, котоую укажем.

7.В multer-config.js - Создаем объект настроек - multerConfig, вызываем метод discStorage и передаем ему объект, в котором описываем настройки - нужна только 1 обязательная настройка - destination (путь ко временной папке), адрес запроса пишем через path, поэтому импортируем path

8.Создаем путь ко временной папке - tempDir (все файлы сначала будут сохраняться тут)

9.Вторая настройка - это filename - туда мы передаем функцию и она может сохранить нам файл не под тем именем, под которым он пришел, это иногда необходимо

10.Создаем middleware (upload)- вызываем multer как функцию, передаем объект настроек - в свойстве storage указываем multerConfig - настройки multer. Middleware готов, она будет сохранять файлы в папке tempDir под оригинальным именем (originalname)

В схему user добавляем
avatarURL: {
type: String,
required: true,
},

для создания аватарки при регистрации установим пакет gravatar

импортируем gravatar в controllers/auth.js
чтобы сгенерировать ссылку на временный аватар, у объeкта gravatar вызываем метод url и передаем email и сохраняем в базе. Теперь, когда человек регистрируется, ему будет дана временная аватарка.

В routes/api/auth.js дописываем маршрут PATCH, чтобы залогиненный пользователь имел возможность заменить аватарку.

После регистрации, логина, можно взять токен и использовать его в PATCH запросе для смены аватарки.

В routes/api/auth.js добавляем в PATCH запрос на avatars, authenticate и где будет передаваться 1 поле avatars с файлом.

Дальше пишем контроллер updateAvatars в controllers/auth.js.
Сохраняем путь к папке с аватарками - avatarsDir, импортируем path.
Импортируем путь tempUpload и originalname.
Создаем путь где файл должен сохраниться resultUpload.
С помощью fs.rename перемещаем файл со временного места - папки temp в постоянное - public/avatars.
Теперь записываем файл в базу - создаем avatarURL. Благодаря middleware aithenticate в req.user у нас сохраняется id пользователя, который делает запрос.
Зная этот id мы можем перезаписать avatarURL.
Нужно сделать уникальное имя файла - мы берем originalname и дописываем к нему id пользователя.

Обработать аватарку пакетом npm i jimp.

<!-- 11.Для middleware upload нужно указать в каких полях мы ожидаем файл. мы ожидаем 1 файл в поле avatar - upload.single("avatar") - это указано также в Postman - /avatars - POST - form-data - avatar + загруженное фото

12.Нажав send в Postman, middleware сохранил фото в папке temp, в req.file - информацию про файл, а в req.body - все текстовые элементы. Далее контроллер берет файл из временной папки и делает с ним то, что необходимо.

13.// upload.array("avatar", 8) - если нужно загрузить больше, чем 1 файл - название поля, количество

14.// upload.fields([{name: "cover", maxCount: 1}, {name: "subcover", maxCount: 2}]) - если ожидаем файлы в разных полях

15.Теперь нужно переместить файлы из temp в public/avatars. За все перемещения файлов отвечает пакет fs. Импортируем его

16.Чтобы переместить файл, в fs используется метод rename -
await fs.rename(tempUpload, resultUpload); -
1й аргумент - старый путь к файлу + его имя; 2й аргумент - новый путь к файлу + его имя;

17.Записываем в базу новый аватар

18.Прописываем app.use(express.static("public")); - Если придет запрос на статичный файл, его нужно искать в папке public -->
